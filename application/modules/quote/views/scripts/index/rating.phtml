<?php
#Zend_Debug::Dump($this->results);
#Zend_Debug::Dump($this->quote_data);
#Zend_Debug::Dump($this->verification);

reset($this->verification);
$current = current($this->verification);
$this->current = $current;
$tick = $current->symbol;
$dtick = $current->delayed_symbol;

$date = new Zend_Date();
?>

<?php require_once 'simple_qf_nav.phtml'; ?>

<!-- Begin Rating -->
<div class="yui3-g-r" style="margin-top: 1em;">
    <div class="yui3-u-2-3"><div style="padding-right: .25em;">
    <!-- Begin First Column -->
        
        
<?php
if ($db = Zend_Registry::get('db')) {
    if (!isset($this->internal->member)) {
?>
        <form onclick="return YAHOO.viame.shadowbox.shadowto('/member/login/p/no_layout/1/simple_content/1/signup_entrance/StockHQ-Rating/', { width: '360px', fixedcenter: true, close: true, draggable: false, modal: true, visible: false }); return false;">
            <table width="100%" class="stock_rating" style="text-align: center;">
                <tr>
                    <td style="padding-bottom: .5em;">
                        <table width="100%"><tr>
                            <td align="center" style="padding-right: .25em;"><a id="stock_rating-buy" href="/member/login/p/signup_entrance/StockHQ-Rating/" class="fakebutton green" onclick="return YAHOO.viame.shadowbox.shadowto('/member/login/p/no_layout/1/simple_content/1/signup_entrance/StockHQ-Rating/', { width: '360px', fixedcenter: true, close: true, draggable: false, modal: true, visible: false });">Rate <?= $current->internal_symbol ?> A Buy</a></td>
                            <td align="center" style="padding-left: .25em;"><a id="stock_rating-sell" href="/member/login/p/signup_entrance/StockHQ-Rating/" class="fakebutton red" onclick="return YAHOO.viame.shadowbox.shadowto('/member/login/p/no_layout/1/simple_content/1/signup_entrance/StockHQ-Rating/', { width: '360px', fixedcenter: true, close: true, draggable: false, modal: true, visible: false });">Rate <?= $current->internal_symbol ?> A Sell</a></td>
                        </tr></table>
                         
                    </td>
                </tr>
                <tr>
                    <td><textarea name="notes" class="vmfh_expandable_textarea" disabled="disabled" onclick="return YAHOO.viame.shadowbox.shadowto('/member/login/p/no_layout/1/simple_content/1/signup_entrance/StockHQ-Rating/', { width: '360px', fixedcenter: true, close: true, draggable: false, modal: true, visible: false });" style="height: 4em; font-style: italic; overflow: auto;">Please explain why you chose your rating and help others learn more about the sentiment of this stock.</textarea></td>
                </tr>
                <tr>
                    <td align="right" style="padding: .5em 0 0 0;"><input id="stock_rating-form-submit" type="submit" value="Submit Rating" onclick="return YAHOO.viame.shadowbox.shadowto('/member/login/p/no_layout/1/simple_content/1/signup_entrance/StockHQ-Rating/', { width: '360px', fixedcenter: true, close: true, draggable: false, modal: true, visible: false });" /></td>
                </tr>
            </table>
        </form>
<?php
    }
    else {
        if ($vote = $db->fetchRow('SELECT * FROM pick_picks WHERE close_datestamp ISNULL AND close_temp_price ISNULL AND close_price ISNULL AND profile_id=? AND symbol_id=? ORDER BY creation DESC LIMIT 1', array($this->internal->member->profile->id, $this->symbol_id))) {
            $close_position_link = '/via/'. $vote->via_id . '/pick/close/p/mid/' . $vote->matrix_counter . '/id/' . $vote->counter . '/allocation/'.$vote->allocation.'/vmpd_fp/1/';
            if ($vote->position < 0) {
                if ($vote->open_price) {
                    echo '<a href="' . $close_position_link . '" class="fakebutton yellow" style="display: block; text-align: center; color: #000; font-weight: normal; font-size: 22px;">Cancel Your Current <strong>Sell</strong> Rating On '.$current->internal_symbol.'</a>';
                }
                else {
                    #echo 'Your <strong>Sell Rating</strong> on <strong>'.$current->internal_symbol.'</strong> is being processed.<br />Please check back later.';
                    echo $this->CM(array(
                        'class' => 'cm decorated plain successmessage',
                        'hd' => 'Processing Rating',
                        'hd2' => 'Your recent sell rating is being processed.',
                        'bd' => '<p class="success">Processing Your Rating...</p><p>Your <strong>Sell Rating</strong> on <strong>'.$current->internal_symbol.'</strong> is currently being processed. Please check back later for more options, such as closing or changing your rating.</p>'
                    ));
                }
            }
            else {
                if ($vote->open_price) {
                    echo '<a href="' . $close_position_link . '" class="fakebutton yellow" style="display: block; text-align: center; color: #000; font-weight: normal; font-size: 22px;">Cancel Your Current <strong>Buy</strong> Rating On '.$current->internal_symbol.'</a>';
                }
                else {
                    #echo 'Your <strong>Buy Rating</strong> on <strong>'.$current->internal_symbol.'</strong> is being processed.<br />Please check back later.';
                    echo $this->CM(array(
                        'class' => 'cm decorated plain successmessage',
                        'hd' => 'Processing Rating',
                        'hd2' => 'Your recent buy rating is being processed.',
                        'bd' => '<p class="success">Processing Your Rating...</p><p>Your <strong>Buy Rating</strong> on <strong>'.$current->internal_symbol.'</strong> is currently being processed. Please check back later for more options, such as closing or changing your rating.</p>'
                    ));
                }
            }
        }
        else {
?>
<script type="text/javascript">
//<![CDATA[
    var default_textarea_text = 'Please explain why you chose your rating and help others learn more about the sentiment of this stock.';
    var default_action;
    function check_stock_rating_form () {
        //alert('checking form');
        
        if (!$('#stock_rating-form input[name=position]').val()) {
            alert('Please select a rating for <?= $current->internal_symbol ?>\nof either Buy or Sell.');
            return false;
        }
        
        if ((!($('#stock_rating-form textarea[name=notes]').val()) || $('#stock_rating-form textarea[name=notes]').val() == default_textarea_text) && confirm("Would you like add a comment to your rating?\n\nTo go back and add a comment, click OK.\nTo submit your rating without a comment, click Cancel.")) {
            $('#stock_rating-form textarea[name=notes]').focus();
            return false;
        }
        
        if ($('#stock_rating-form textarea[name=notes]').val() == default_textarea_text) {
            $('#stock_rating-form textarea[name=notes]').val('')
        }
        
        if (!default_action) {
            default_action = $('#stock_rating-form').attr('action');
        }
        
        var tempAdd = '%26vmpd_fp%3D1';
        tempAdd += '%26position%3D' + encodeURIComponent($('#stock_rating-form input[name=position]').val());
        tempAdd += '&notes%3D' + encodeURIComponent(encodeURIComponent(encodeURIComponent($('#stock_rating-form textarea[name=notes]').val())));
        tempAdd += '/';
        
        $('#stock_rating-form').attr('action', default_action + tempAdd)
        //alert($('#stock_rating-form').attr('action'));
        
        return true;
    }
//]]>
</script>
        <form id="stock_rating-form" action="/module/setup/publish/module_name/pick/extra_params/symbol%3D<?= $current->internal_symbol ?>%26allocation%3D1" onsubmit="return check_stock_rating_form();">
            <input type="hidden" name="position" />
            <table width="100%" class="stock_rating" style="text-align: center;">
                <tr>
                    <td style="padding-bottom: .5em;">
                        <table width="100%"><tr>
                            <td align="center" style="padding-right: .25em;"><a id="stock_rating-buy" href="/module/setup/publish/module_name/pick/extra_params/symbol%3D<?= $current->internal_symbol ?>%26position%3D1%26allocation%3D1%26vmpd_fp%3D1/" class="fakebutton green" onclick="$(this).addClass('green'); $('#stock_rating-sell').removeClass('red'); $('#stock_rating-form input[name=position]').val('1'); $('#stock_rating-form-submit').val('Submit Buy Rating on <?= $current->internal_symbol ?>'); return false;">Rate <?= $current->internal_symbol ?> A Buy</a></td>
                            <td align="center" style="padding-left: .25em;"><a id="stock_rating-sell" href="/module/setup/publish/module_name/pick/extra_params/symbol%3D<?= $current->internal_symbol ?>%26position%3D-1%26allocation%3D1%26vmpd_fp%3D1/" class="fakebutton red" onclick="$(this).addClass('red'); $('#stock_rating-buy').removeClass('green'); $('#stock_rating-form input[name=position]').val('-1'); $('#stock_rating-form-submit').val('Submit Sell Rating on <?= $current->internal_symbol ?>'); return false;">Rate <?= $current->internal_symbol ?> A Sell</a></td>
                        </tr></table>
                         
                    </td>
                </tr>
                <tr>
                    <td><textarea name="notes" class="vmfh_expandable_textarea" onblur="if (this.value == '') { this.style.fontStyle='italic';  this.value = default_textarea_text; }" onfocus="if (this.value == default_textarea_text) { this.value = ''; this.style.fontStyle='normal'; }" style="height: 4em; font-style: italic; overflow: auto;">Please explain why you chose your rating and help others learn more about the sentiment of this stock.</textarea></td>
                </tr>
                <tr>
                    <td align="right" style="padding: .5em 0 0 0;"><input id="stock_rating-form-submit" type="submit" value="Submit Rating" /></td>
                </tr>
            </table>
        </form>
<?php
        }
    }
    
    $select = clone $this->ratings_select_query_base;
    $select->where('obj.symbol_id=?', $this->symbol_id);
    $select->where('obj.partial_close_parent_id ISNULL');
    
    $select->limit(50);
    $select->order('obj.creation DESC');
    
    $objects = $db->fetchAll($select);
    $counter = 0;
    foreach ($objects as $object) {
        if (!$counter) { echo '<table width="100%" class="stock_rating" style="margin-top: 1em;">'; }
        
        $this->module = 'pick';
        $content_link = $this->ContentLink(array('object' => $object, 'view' => $this));
        $this->module = 'quote';
        
        /*
        $mid = $object->matrix_counter;
        $title = (isset($object->x_display) && $object->x_display ? $object->x_display : (isset($object->m_display) && $object->m_display ? $object->m_display : $object->m_name));
        if ($object->com_id) {
            $type = 'com';
            $id = $object->com_id;
        }
        elseif ($object->net_id) {
            $type = 'net';
            $id = $object->net_id;
        }
        elseif ($object->via_id) {
            $type = 'via';
            $id = $object->via_id;
        }
        
        $link = 'https://' . $this->internal->vars->host;
        if ($title) { $link .= '/' . $this->SEO_Urlify($title) . '/s'; }
        $link .= "/$type/$id/pick/p/mid/$mid/?status=1";
        */
?>
        <tr><td colspan="2"><hr style="margin: 1em 0;" /></tr>
        <tr>
            <td style="width: 150px; text-align: left; vertical-align: top;">
                <div class="image_area">
                    <div class="headshot<?= !(isset($object->p_picture_url) && $object->p_picture_url) ? ' VIA_default' : '' ?>">
                        <a href="<?= $this->ProfileDisplay(array('profile' => $object, 'href_only' => true, 'internal' => $this->internal)) ?>" class="headshot_link">
            <?php   if (isset($object->p_picture_url) && $object->p_picture_url) { ?>
                            <img src="<?= (preg_match('#http://#i', $object->p_picture_url) ? '' : $this->internal->config->upload->picture_server . '/') ?><?= $this->escape($object->p_picture_url) ?>" />
            <?php   } ?>
                        </a>
                    </div>
                </div>
                <div class="followers"><?= $object->p_total_followers_count ?></div>
                
                <div style="clear: both; font-size: 11px;">
                    <?= $this->ProfileDisplay(array('profile' => $object, 'internal' => $this->internal)) ?>
                    <a href="/via/<?= $object->p_id ?>/pick/p/mid/<?= $object->matrix_counter ?>/?status=1" style="display: block; margin-top: .25em;">View All Ratings</a>
                </div>
            </td>
            <td style="text-align: left; vertical-align: top;">
                <div style="margin-bottom: 14px; font-size: 11px;">
                    <a href="<?= $content_link ?>" class="fakebutton <?= ($object->position == -1 ? 'red' : 'green') ?>" style="margin-right: .5em; padding: 2px 4px; font-size: 11px; font-weight: normal;"><?= ($object->position == -1 ? 'Sell' : 'Buy') ?> Rating</a>
                    <span>
<?php
    $date->set((isset($object->published) && $object->published ? $object->published : $object->creation), Zend_Date::ISO_8601);
    if (isset($this->internal->member)) {
        $date->setTimezone($this->internal->member->timezone);
        echo $date->toString(Zend_Date::DATE_SHORT);
    }
    else {
        $date->setTimezone($this->internal->config->timezone);
        echo $date->toString(Zend_Date::DATE_SHORT);
    }
?>
                    @
                    <?php $currency = new ViaMe_Currency(array('currency' => 'USD'));  echo $currency->toCurrency(isset($object->open_price) && $object->open_price ? $object->open_price : $object->open_temp_price); ?>
                    </span>
<?php
if (isset($object->modified) && $object->modified) {
    $sdate = new DateTime(isset($object->published) && $object->published ? $object->published : $object->creation);
    $sdate->setTime(0, 0, 0);
    #echo $sdate->format("Y-m-d\TH:i:s\Z");
    $udate = new DateTime($object->modified);
    $udate->setTime(0, 0, 0);
    #echo $udate->format("Y-m-d\TH:i:s\Z");
    if ($udate > $sdate) {
        $updated_date = new Zend_Date();
        $updated_date->set($object->modified, Zend_Date::ISO_8601);
        if (isset($this->internal->member)) {
            $updated_date->setTimezone($this->internal->member->timezone);
        }
        else {
            $updated_date->setTimezone($this->internal->config->timezone);
        }
        
        echo '<span> - Updated: ' . $updated_date->toString(Zend_Date::DATE_SHORT) . '</span>';
    }
}
?>
                    <span style="float: right;">
<?php
if (isset($object->close_datestamp) && $object->close_datestamp &&
    ((isset($object->close_price) && $object->close_price) || (isset($object->close_temp_price) && $object->close_temp_price))) {
    $date->set($object->close_datestamp, Zend_Date::ISO_8601);
    echo '<strong>Closed:</strong> ';
    echo $date->toString(Zend_Date::DATE_SHORT);
    echo ' @ ';
    echo $currency->toCurrency(isset($object->close_price) && $object->close_price ? $object->close_price : $object->close_temp_price);
    $change = ((isset($object->close_price) && $object->close_price ? $object->close_price : $object->close_temp_price) - (isset($object->open_price) && $object->open_price ? $object->open_price : $object->open_temp_price)) * $object->position;
    $perc = $change / (isset($object->open_price) && $object->open_price ? $object->open_price : $object->open_temp_price) * 100;
    echo ' <span';
    if ($change > 0) { echo ' class="netup"'; }
    elseif ($change < 0) { echo ' class="netdown"'; }
    echo '>';
    #echo $currency->toCurrency($change);
    echo ' (' . Zend_Locale_Format::toNumber($perc, array('locale' => $this->internal->locale, 'precision' => 2)) . '%)';
    echo '</span>';
    #5/22/13 @ $12.33 (+5.88%)';
}
else {
    echo 'Performance: ';
    $change = ($this->results[3] - (isset($object->open_price) && $object->open_price ? $object->open_price : $object->open_temp_price)) * $object->position;
    $perc = $change / (isset($object->open_price) && $object->open_price ? $object->open_price : $object->open_temp_price) * 100;
    echo '<span';
    if ($change > 0) { echo ' class="netup"'; }
    elseif ($change < 0) { echo ' class="netdown"'; }
    echo '>';
    echo $currency->toCurrency($change);
    echo ' (' . Zend_Locale_Format::toNumber($perc, array('locale' => $this->internal->locale, 'precision' => 2)) . '%)';
    echo '</span>';
}
?>
                    </span>
                </div>
                <?= (isset($object->title) && $object->title && !preg_match('/^(buy long|sell short)/i', $object->title) ? '<h3>' . $object->title . '</h3>': '') ?>
                <div>
<?php 
    if (isset($object->content) && $object->content) {
        echo $object->content;
    }
    elseif (isset($object->notes) && $object->notes) {
        echo '<pre style="white-space: pre-wrap; line-height: inherit; font-family: inherit;">' . $this->escape($object->notes) . '</pre>';
    }
    else {
        echo '<div style="margin: 1em 0;"><i>No Comment</i></div>';
    }
?>
                </div>
                <div class="bottom_links" style="margin-top: 1em; font-size: 10px;">
                    <?= $this->PrintEmailLink(array('link' => $content_link, 'internal' => $this->internal, 'print_text' => 'Print Rating', 'email_text' => 'Send to a Friend')) ?>
                    <a href="<?= $content_link ?>" class="the_link_link"><span class="icon"></span><span class="the_link">Link to this Rating</span></a>
                </div>
            </td>
        </tr>
<?php
        #Zend_Debug::Dump($object);
        $counter++;
    }
    if ($counter) {
        // Close table if necesary
        echo '</table>';
    }
    else {
?>
    <div style="margin: 2em 0; text-align: center; font-size: 18px; font-weight: bold;">Be the first investor to rate this stock.</div>
<?php
    }
}
?>
    <!-- End First Column -->
    </div></div>
    <div class="yui3-u-1-3"><div style="padding-left: .25em;">
    <!-- Begin Second Column -->
    
        <div class="cm decorated">
            <div class="bd" style="padding: 1em;">
                <p style="margin: 0 0 12px 0; padding: 0; text-align: center; font-size: 180%; font-weight: bold;">Total # Ratings : <span id="tf_total_num_ratings"><?= Zend_Locale_Format::toNumber($rating->total, array('locale' => $this->internal->locale)) ?></span></p>
                
                <table align="center" style="font-size: 110%;">
                    <tr><td align="right"> Total # <strong class="netup">Buy</strong> Ratings : </td><td style="padding-left: .5em;"><span id="tf_total_num_buy_ratings"><?= Zend_Locale_Format::toNumber(($rating->total - (($rating->total - ($rating->total * $rating->rating)) / 2)), array('locale' => $this->internal->locale)) ?><?= ($rating->total) ? ' (' . Zend_Locale_Format::toNumber((($rating->total - (($rating->total - ($rating->total * $rating->rating)) / 2)) / $rating->total * 100), array('locale' => $this->internal->locale, 'precision' => 2)) . '%)' : '' ?></span></td></tr>
                    <tr><td align="right">Total # <strong class="netdown">Sell</strong> Ratings : </td><td style="padding-left: .5em;"><span id="tf_total_num_sell_ratings"><?= Zend_Locale_Format::toNumber((($rating->total - ($rating->total * $rating->rating)) / 2), array('locale' => $this->internal->locale)) ?><?= ($rating->total) ? ' (' . Zend_Locale_Format::toNumber(((($rating->total - ($rating->total * $rating->rating)) / 2) / $rating->total * 100), array('locale' => $this->internal->locale, 'precision' => 2)) . '%)' : '' ?></span></td></tr>
                </table>
                
            </div>
        </div>
        
<?php
/* SELECT DATA - Put LIMIT and ORDER on SELECT OUTSIDE of the SELECT with window functions - Flip the order last after limiting

SELECT * FROM (
    SELECT * FROM
    (
        SELECT DISTINCT real_date, AVG(position) OVER (ORDER BY real_date) AS rating, COUNT(NULLIF(position, -1)) OVER (partition BY real_date) AS day_buy, COUNT(NULLIF(position, 1)) OVER (partition by real_date) AS day_sell, COUNT(creation) OVER (PARTITION BY real_date) AS day_total, COUNT(creation) OVER (ORDER BY real_date) AS running_total FROM
            (
                SELECT COALESCE(date(n1.creation), n2.date) AS real_date, * FROM
                    (
        				SELECT * FROM pick_picks WHERE symbol_id=201
                    ) n1
                FULL OUTER JOIN
                    (
                        SELECT DATE('now'::timestamp - '30 Days'::interval + (gs::text || '   Days')::interval) AS date FROM generate_series(0, 30) AS gs
                    ) n2
                ON date(n1.creation)=n2.date
                
            ) sq1
        ORDER BY real_date
    ) tt
    ORDER BY real_date DESC
    LIMIT 30
) uu
ORDER BY real_date
*/
?>
<?php
if ($rating->total && ($db || $db = Zend_Registry::get('db'))) {
    $query = "
SELECT * FROM (
    SELECT * FROM
    (
        SELECT DISTINCT real_date, TO_CHAR(real_date, 'FMMM/FMDD/YYYY') AS real_date_converted, AVG(position) OVER (ORDER BY real_date) AS rating, COUNT(NULLIF(position, -1)) OVER (partition BY real_date) AS day_buy, COUNT(NULLIF(position, 1)) OVER (partition by real_date) AS day_sell, COUNT(this_creation) OVER (PARTITION BY real_date) AS day_total, COUNT(this_creation) OVER (ORDER BY real_date) AS running_total FROM
            (
                SELECT COALESCE(n1.date, n2.date) AS real_date, * FROM
                    (
        				SELECT date(obj.creation) AS date, obj.creation AS this_creation, * FROM \"pick_picks\" AS \"obj\" INNER JOIN \"module_matrix\" AS \"x\" ON obj.com_id=x.com_id AND obj.net_id=x.net_id AND obj.via_id=x.via_id AND obj.module_id=x.module_id AND obj.matrix_counter=x.counter INNER JOIN \"module_modules\" AS \"m\" ON x.module_id=m.id INNER JOIN \"profile_profiles\" AS \"p\" ON obj.profile_id = p.id INNER JOIN \"member_members\" AS \"b\" ON p.member_id = b.id INNER JOIN \"system_communities\" AS \"c\" ON p.community_id = c.id INNER JOIN \"quote_view_symbol_matrix\" AS \"qx\" ON obj.symbol_id=qx.id WHERE (x.active='t') AND (m.active='t') AND (p.active='t') AND (b.active='t') AND (c.active='t') AND ((obj.com_id='2') OR (m.allow_flow='t' AND x.allow_out_flow AND (obj.net_id = 0 OR (ARRAY[obj.via_id, x.counter] :: text ~ E'()' AND x.allow_community_outflow && ARRAY[2] :: bigint[])))) AND (obj.active='t') AND (obj.activation ISNULL OR obj.activation <= now()) AND (obj.expiration ISNULL OR obj.expiration >= now()) AND (obj.partial_close_parent_id ISNULL) AND (obj.symbol_id=?)
                    ) n1
                FULL OUTER JOIN
                    (
                        SELECT DATE('now'::timestamp - '30 Days'::interval + (gs::text || '   Days')::interval) AS date FROM generate_series(0, 30) AS gs
                    ) n2
                ON n1.date=n2.date
                
            ) sq1
        ORDER BY real_date
    ) tt
    ORDER BY real_date DESC
    LIMIT 30
) uu
ORDER BY real_date
    ";
    #echo $query;
    $ratings_data = $db->fetchAll($query, $this->symbol_id);
    if (count($ratings_data)) {
?>
        <div class="cm decorated"><div class="bd" style="padding: 1em;"><p style="margin: 0 0 1em 0; padding: 0;"><strong><?= $current->internal_symbol ?> Ratings History - Last 30 Days</strong></p><div id="ratingchart" style="height: 200px;"></div></div></div>
<script type="text/javascript">
(function() {
    YUI().use('charts', function (Y) 
    { 
        var ratingDataValues = [
<?php
        foreach ($ratings_data as $data) {
            echo '{date: "' . $data->real_date_converted. '", sell: ' . $data->day_sell . ', buy: ' . $data->day_buy . ', rating: ' . sprintf("%.2f", (!is_null($data->rating) ? (((($data->rating + 1) / 2 * 9) + 1) / 2) : 0)) . ' },' . "\n";
        }
?>
        ];
        
		//Define axes and assign keys
		var ratingAxes = {
			count: {
			    //title: "Count",
				type: "numeric",
				position: "right",
				keys: ["buy", "sell"],
				type: "stacked",
				labelFormat: {
					//prefix:"$",
					thousandsSeparator: ","
				},
				alwaysShowZero: true,
				minimum: 0,
				//hideLastMajorUnit: true,
				styles:{
					label: {
						fontSize: "10px"
					}
				},
			},
			rating: {
			    //title: "Rating",
				type: "numeric",
				position: "left",
				keys: ["rating"],
				labelFormat: { suffix: " Stars" },
				alwaysShowZero: true,
				minimum: 0,
				maximum: 5.5,
				majorUnit: 1,
				minorUnit: 1,
				hideLastMajorUnit: true,
				//topTickOffset: 50,
				styles:{
					label: {
						fontSize: "10px"
					},
					majorUnit: {
					    determinant: "count",
					    count: 12,
					    //distance: 1
					}
				}
			},
			date:{
				calculateEdgeOffset: true,
				position: "bottom",
				keys: ["date"],
				type: "time",
				styles:{
					label: {
						fontSize: "8px",
						rotation: -45,
						margin: { top: 3 }
					}
				}
			}
		};
	
		//Define a series collection so that we can assign nice display names
		var ratingSeries = [
			{ yKey: "sell", yDisplayName: "# Sell Ratings", xDisplayName: "Date"},
			{ yKey: "buy", yDisplayName: "# Buy Ratings", xDisplayName: "Date"},
			{ type: "combo", yKey: "rating", yDisplayName: "Rating", xDisplayName: "Date"}
		];
		
		var ratingchart = new Y.Chart({
			dataProvider: ratingDataValues,
			type: "column", 
			stacked:true,
			axes: ratingAxes,
			seriesCollection: ratingSeries,
			render: "#ratingchart",
			/*
			horizontalGridlines: {
                styles: {
                    line: {
                        color: "#dad8c9"
                    }
                }
            },
            verticalGridlines: {
                styles: {
                    line: {
                        color: "#dad8c9"
                    }
                }
            },
            */
			styles: {
			    graph: {
			        background: {
                        fill : {   
                            //color : "#faf9f2"
                            
                        },
                        border : {
                            color : "#dad8c9",
                            weight : 1   
                        }
                    }
			    },
				series: {
					sell: {
						line: {
							color: "#ca2413"
						},
						marker: {
							fill: {
								color: "#ca2413"
							},
							over: {
								fill: {
									color: "#FF0000"
								}
							},
							width: 6
						}
					},
					buy: {
						line: {
							color: "#05AB19"
						},
						marker: {
							fill: {
								color: "#05AB19"
							},
							over: {
								fill: {
									color: "#00FF00"
								}
							},
							width: 6
						}
					},
					rating: {
						line:{
							color: "#ccc",
							weight: 2
						},
						marker:
						{
							fill:{
								color:"#ddd"
							},
							border:{
								color:"#999"
							},
							over: {
								fill: {
									color: "#eee"
								},
								border: {
									color: "#000"
								}
							},
							width: 4,
							height: 4
						}
					}
				}
			}
		});
    });
})();
</script>
<?php
    }
}
?>

<?php
if ($rating->total && ((isset($db) && $db) || $db = Zend_Registry::get('db'))) {
    $query = 'SELECT sq.*, random() FROM (SELECT "obj".symbol_id, "qx"."internal_symbol" AS "qx_internal_symbol", "qx"."name" AS "qx_name", "qx"."type" AS "qx_type", "qx"."exch" AS "qx_exch", "qx"."internal_symbol" AS "qx_internal_symbol", "qx"."delayed_symbol" AS "qx_delayed_symbol", "qx"."realtime_symbol" AS "qx_realtime_symbol", COUNT(*) AS rating_total, AVG("obj".position) AS rating_rating, MAX(COALESCE("obj".published, "obj".creation)) AS rating_max_creation FROM "pick_picks" AS "obj" INNER JOIN "module_matrix" AS "x" ON obj.com_id=x.com_id AND obj.net_id=x.net_id AND obj.via_id=x.via_id AND obj.module_id=x.module_id AND obj.matrix_counter=x.counter INNER JOIN "module_modules" AS "m" ON x.module_id=m.id INNER JOIN "profile_profiles" AS "p" ON obj.profile_id = p.id INNER JOIN "member_members" AS "b" ON p.member_id = b.id INNER JOIN "system_communities" AS "c" ON p.community_id = c.id INNER JOIN "quote_view_symbol_matrix" AS "qx" ON obj.symbol_id=qx.id WHERE' .
        "(x.active='t') AND (m.active='t') AND (p.active='t') AND (b.active='t') AND (c.active='t') AND ((obj.com_id='" . $this->internal->community->id . "') OR (m.allow_flow='t' AND x.allow_out_flow AND (obj.net_id = 0 OR (ARRAY[obj.via_id, x.counter] :: text ~ E'()' AND x.allow_community_outflow && ARRAY[" . $this->internal->community->id . "] :: bigint[])))) AND (obj.active NOTNULL AND ((obj.active='t' AND (obj.activation ISNULL OR obj.activation <= now()) AND (obj.expiration ISNULL OR obj.expiration >= now())))) AND obj.partial_close_parent_id ISNULL AND obj.symbol_id<>'" . $this->symbol_id . "' AND (obj.symbol_id IN (SELECT DISTINCT symbol_id FROM pick_picks WHERE profile_id IN ( SELECT DISTINCT profile_id FROM pick_picks WHERE symbol_id='" . $this->symbol_id . "' ))) GROUP BY " .
        '"obj".symbol_id, "qx"."symbol", "qx"."name", "qx"."type", "qx"."exch", "qx"."internal_symbol", "qx"."delayed_symbol", "qx"."realtime_symbol") AS sq ORDER BY random() LIMIT 10';
    $others = $db->fetchAll($query);
    if (count($others)) {
        $counter = 0;
        echo '<div class="cm decorated"><div class="bd"><p><strong>People Who Rated This Stock Also Rated...</strong></p>';
        foreach ($others as $other) {
            $other_link = 'https://' . $this->internal->vars->host . '/' . ($other->qx_name ? $this->SEO_Urlify($other->qx_name) . '/s/' : '' ) . 'quote/p/s/' . urlencode($other->qx_internal_symbol) . '/';
            $the_rating_value = sprintf("%.1f", (intval(($other->rating_rating + 1) / 2 * 9) + 1) / 2);
        
            echo "<div style=\"margin: 0 1em;\"><a href=\"$other_link\" class=\"quote_symbol\">" . $other->qx_name . ' (' . $this->escape($other->qx_internal_symbol) . ')</a></div>';
            #rating_total, rating_rating, rating_max_creation
            echo '<div style="margin: 0 1em 1em 1.5em; text-align: left; font-size: 11px; line-height: 16px;" class="stock_rating">';
            echo '<span class="star_rating small stars'.preg_replace('/\./', '-', $the_rating_value).'" style="margin-right: 3px;">'.$the_rating_value.'</span>';
            echo $other->rating_total . ' Rating(s)';
            if (isset($other->rating_max_creation) && $other->rating_max_creation) {
                echo '<span style="float: right;">Last Rated: ';
                $date->set($other->rating_max_creation, Zend_Date::ISO_8601);
                echo $date->toString(Zend_Date::DATE_SHORT);
            }
            echo '</div>';
            $counter++;
        }
        echo '</div></div>';
    }
}
?>



<?php
if ($db || $db = Zend_Registry::get('db')) {
    $query = 'SELECT "obj".symbol_id, "qx"."internal_symbol" AS "qx_internal_symbol", "qx"."name" AS "qx_name", "qx"."type" AS "qx_type", "qx"."exch" AS "qx_exch", "qx"."internal_symbol" AS "qx_internal_symbol", "qx"."delayed_symbol" AS "qx_delayed_symbol", "qx"."realtime_symbol" AS "qx_realtime_symbol", COUNT(*) AS rating_total, AVG("obj".position) AS rating_rating, MAX(COALESCE("obj".published, "obj".creation)) AS rating_max_creation, '.
        "COUNT(NULLIF('f', obj.creation > ('now'::timestamp - '7 Days'::interval))) AS ".
        '"rating_count_recent" FROM "pick_picks" AS "obj" INNER JOIN "module_matrix" AS "x" ON obj.com_id=x.com_id AND obj.net_id=x.net_id AND obj.via_id=x.via_id AND obj.module_id=x.module_id AND obj.matrix_counter=x.counter INNER JOIN "module_modules" AS "m" ON x.module_id=m.id INNER JOIN "profile_profiles" AS "p" ON obj.profile_id = p.id INNER JOIN "member_members" AS "b" ON p.member_id = b.id INNER JOIN "system_communities" AS "c" ON p.community_id = c.id INNER JOIN "quote_view_symbol_matrix" AS "qx" ON obj.symbol_id=qx.id WHERE ' .
        "(x.active='t') AND (m.active='t') AND (p.active='t') AND (b.active='t') AND (c.active='t') AND ((obj.com_id='" . $this->internal->community->id . "') OR (m.allow_flow='t' AND x.allow_out_flow AND (obj.net_id = 0 OR (ARRAY[obj.via_id, x.counter] :: text ~ E'()' AND x.allow_community_outflow && ARRAY[" . $this->internal->community->id . "] :: bigint[])))) AND (obj.active NOTNULL AND ((obj.active='t' AND (obj.activation ISNULL OR obj.activation <= now()) AND (obj.expiration ISNULL OR obj.expiration >= now())))) AND obj.partial_close_parent_id ISNULL AND obj.symbol_id<>'" . $this->symbol_id . "' GROUP BY " .
        '"obj".symbol_id, "qx"."symbol", "qx"."name", "qx"."type", "qx"."exch", "qx"."internal_symbol", "qx"."delayed_symbol", "qx"."realtime_symbol" HAVING '.
        "COUNT(NULLIF('f', obj.creation > ('now'::timestamp - '7 Days'::interval))) > 0 ORDER BY rating_count_recent DESC, rating_max_creation DESC LIMIT 10";
    $others = $db->fetchAll($query);
    if (count($others)) {
        $counter = 0;
        echo '<div class="cm decorated"><div class="bd" style=""><p><strong>Stocks Trending Up In Ratings Activity...</strong></p>';
        foreach ($others as $other) {
            $other_link = 'https://' . $this->internal->vars->host . '/' . ($other->qx_name ? $this->SEO_Urlify($other->qx_name) . '/s/' : '' ) . 'quote/p/s/' . urlencode($other->qx_internal_symbol) . '/';
            $the_rating_value = sprintf("%.1f", (intval(($other->rating_rating + 1) / 2 * 9) + 1) / 2);
        
            echo "<div style=\"margin: 0 1em;\"><a href=\"$other_link\" class=\"quote_symbol\">" . $other->qx_name . ' (' . $this->escape($other->qx_internal_symbol) . ')</a></div>';
            #rating_total, rating_rating, rating_max_creation
            echo '<div style="margin: 0 1em 1em 1.5em; text-align: left; font-size: 11px; line-height: 16px;" class="stock_rating">';
            echo '<span class="star_rating small stars'.preg_replace('/\./', '-', $the_rating_value).'" style="margin-right: 3px;">'.$the_rating_value.'</span>';
            echo $other->rating_total . ' Rating(s)';
            if (isset($other->rating_max_creation) && $other->rating_max_creation) {
                echo '<span style="float: right;">Last Rated: ';
                $date->set($other->rating_max_creation, Zend_Date::ISO_8601);
                echo $date->toString(Zend_Date::DATE_SHORT);
            }
            echo '</div>';
            $counter++;
        }
        echo '</div></div>';
    }
}
?>
        
        
        
    <!-- End Second Column -->
    </div></div>
</div>
<!-- End Rating -->




</div>